<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ã‚«ãƒ™åˆæˆ¦ï¼</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Google Fonts: Zen Maru Gothic (è¦ªã—ã¿ã‚„ã™ã„ä¸¸ã‚´ã‚·ãƒƒã‚¯) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" href="favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    /* =========================================
       GIGA Game Standard Design System
       Theme: Modern Pop & Playful
       ========================================= */

    :root {
      /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
      --font-main: 'Zen Maru Gothic', sans-serif;
      --color-primary: #1a73e8; /* Google Blue */
      --color-accent: #ffca28; /* Amber (æ¥½ã—ã•) */
      --color-bg: #fff9c4; /* Yellow 100 (èƒŒæ™¯) */
      --color-text: #37474f; /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼ (æ–‡å­—) */
      
      /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚«ãƒ©ãƒ¼ */
      --p1-color: #2979ff; /* é®®ã‚„ã‹ãªé’ */
      --p2-color: #ff1744; /* é®®ã‚„ã‹ãªèµ¤ */
      
      /* ç›¤é¢ãƒ‡ã‚¶ã‚¤ãƒ³ */
      --board-bg: #ffffff;
      --cell-bg: #f1f3f4;
      --cell-hover: #e3f2fd;
      --wall-color: #8d6e63; /* æœ¨ã®è³ªæ„Ÿã‚’æ„Ÿã˜ã•ã›ã‚‹èŒ¶è‰² */
      --wall-shadow: rgba(0,0,0,0.2);
    }

    body {
      font-family: var(--font-main);
      color: var(--color-text);
      /* GIGAæ¨™æº–èƒŒæ™¯ãƒ‘ã‚¿ãƒ¼ãƒ³: ãƒ‰ãƒƒãƒˆæŸ„ã§ãƒãƒ¼ãƒˆã®ã‚ˆã†ãªè¦ªã—ã¿ã‚„ã™ã•ã‚’æ¼”å‡º */
      background-color: var(--color-bg);
      background-image: radial-gradient(#ffe082 20%, transparent 20%), radial-gradient(#ffe082 20%, transparent 20%);
      background-position: 0 0, 25px 25px;
      background-size: 50px 50px;
      
      /* iOSã§ã®ãƒã‚¦ãƒ³ã‚¹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
      overscroll-behavior: none; 
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* --- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ãƒœã‚¿ãƒ³ --- */
    
    /* æŠ¼ã—ãŸããªã‚‹ã€Œã·ã‚‹ã‚“ã€ã¨ã—ãŸãƒœã‚¿ãƒ³ */
    .pop-btn {
      transition: transform 0.1s, box-shadow 0.1s;
      border-radius: 50rem; /* ã‚«ãƒ—ã‚»ãƒ«å‹ */
      font-weight: 700;
      border: none;
      letter-spacing: 0.05em;
      position: relative;
      overflow: hidden;
    }
    
    /* æŠ¼ã—ãŸç¬é–“ã®ã¸ã“ã¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .pop-btn:active {
      transform: scale(0.92) !important;
    }
    
    /* ãƒ›ãƒãƒ¼æ™‚ã®æµ®ãä¸ŠãŒã‚Šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .pop-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px rgba(0,0,0,0.15) !important;
    }

    .btn-primary-pop {
      background-color: var(--color-primary);
      color: white;
    }
    
    .btn-accent-pop {
      background-color: var(--color-accent);
      color: #3e2723; /* é»„è‰²èƒŒæ™¯ãªã®ã§æ–‡å­—ã¯æ¿ƒã„èŒ¶è‰²ã§è¦‹ã‚„ã™ã */
    }
    
    /* ã‚«ãƒ™ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚¿ã‚¤ãƒ«ã¯JSã§åˆ¶å¾¡ */

    /* --- ã‚²ãƒ¼ãƒ ç›¤é¢ (Board) --- */

    /* ã‚«ãƒ¼ãƒ‰é¢¨ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    .game-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.05);
      border: 4px solid #fff;
      padding: 20px;
      backdrop-filter: blur(5px);
    }

    /* ç›¤é¢ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒªã‚¢ */
    #game-area {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      overflow: auto; /* ç”»é¢ãŒå°ã•ã„æ™‚ç”¨ */
    }

    #board {
      display: grid;
      background-color: var(--board-bg);
      padding: 10px;
      border-radius: 16px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      gap: 4px; /* ãƒã‚¹ç›®ã®é–“éš” */
      touch-action: manipulation; /* ã‚¿ãƒƒãƒæ“ä½œã®æœ€é©åŒ– */
    }

    /* ãƒã‚¹ç›® (Cell) */
    .cell {
      background-color: var(--cell-bg);
      border-radius: 6px;
      position: relative;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .cell:hover {
      background-color: var(--cell-hover); /* ãƒ›ãƒãƒ¼æ™‚ã«ã†ã£ã™ã‚‰é’ã */
    }

    /* --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ (Pawn) --- */
    .pawn {
      width: 70%;
      height: 70%;
      border-radius: 50%;
      position: absolute;
      top: 15%;
      left: 15%;
      z-index: 10;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* ãƒãƒã®ã‚ˆã†ãªæ¥½ã—ã„å‹•ã */
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1 (é’) */
    .pawn.p1 {
      background: radial-gradient(circle at 30% 30%, #64b5f6, var(--p1-color));
      border: 3px solid white;
    }
    
    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2 (èµ¤) */
    .pawn.p2 {
      background: radial-gradient(circle at 30% 30%, #ff8a80, var(--p2-color));
      border: 3px solid white;
    }

    /* æ‰‹ç•ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¼·èª¿è¡¨ç¤ºï¼ˆãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
    .active-turn-indicator {
      box-shadow: 0 0 0 4px var(--color-accent);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 202, 40, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 202, 40, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 202, 40, 0); }
    }

    /* ç§»å‹•å¯èƒ½å ´æ‰€ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆç·‘ã®ä¸¸ï¼‰ */
    .valid-move {
      background-color: rgba(76, 175, 80, 0.5);
      border-radius: 50%;
      width: 30%;
      height: 30%;
      position: absolute;
      top: 35%;
      left: 35%;
      pointer-events: none;
      animation: fadeIn 0.3s ease;
    }

    /* --- ã‚«ãƒ™ (Wall) --- */
    .wall {
      position: absolute;
      background-color: var(--wall-color);
      border-radius: 4px;
      z-index: 20;
      box-shadow: 2px 2px 4px var(--wall-shadow);
      /* ã‚¹ãƒˆãƒ©ã‚¤ãƒ—æ¨¡æ§˜ã§ã€ŒæŸµã€ã£ã½ã•ã‚’æ¼”å‡º */
      background-image: repeating-linear-gradient(
        45deg,
        rgba(255,255,255,0.1),
        rgba(255,255,255,0.1) 5px,
        transparent 5px,
        transparent 10px
      );
    }

    /* --- ãã®ä»–ã®èª¿æ•´ --- */
    
    /* ãƒ«ãƒ“ï¼ˆãµã‚ŠãŒãªï¼‰ */
    ruby {
      ruby-position: over;
    }
    rt {
      font-size: 0.6em;
      color: #78909c; /* å°‘ã—è–„ãã—ã¦èª­ã¿ã‚„ã™ã */
    }

    /* æ•°å­—ã‚’å¤§ããè¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    .wall-count-display {
      font-family: 'Zen Maru Gothic', sans-serif;
      line-height: 1;
    }

    /* ãƒ«ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .rule-step { margin-bottom: 20px; text-align: left; padding: 15px; background: #f9fbe7; border-radius: 10px; border: 2px solid #e6ee9c; }
    .rule-title { font-weight: bold; color: #33691e; font-size: 1.2em; display: flex; align-items: center; margin-bottom: 10px; }
    .rule-icon { font-size: 1.5em; margin-right: 10px; background: #fff; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .rule-visual { text-align: center; margin: 10px 0; font-size: 2em; line-height: 1.2; }
    .rule-desc { font-size: 0.95em; line-height: 1.6; }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ: å°ã•ã„ç”»é¢ã§ã®å¾®èª¿æ•´ */
    @media (max-width: 600px) {
      #board {
        gap: 2px;
        padding: 5px;
      }
      .cell {
        border-radius: 3px;
      }
      .game-card {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <nav class="navbar navbar-light bg-white shadow-sm sticky-top mb-3" style="border-bottom: 4px solid #fff176;">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1 fw-bold text-primary">
        ğŸš§ ã‚«ãƒ™<ruby>åˆæˆ¦<rt>ãŒã£ã›ã‚“</rt></ruby>ï¼
      </span>
      <button id="btn-rule" class="btn btn-outline-primary rounded-circle" style="width: 40px; height: 40px; font-weight:bold;">ï¼Ÿ</button>
    </div>
  </nav>

  <div class="container main-container flex-grow-1">
    
    <!-- ==========================
         1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢
         ========================== -->
    <div id="setup-screen" class="row justify-content-center align-items-center" style="min-height: 60vh;">
      <div class="col-md-8 col-lg-6">
        <div class="card shadow-lg border-0 rounded-4 text-center p-4" style="background-color: rgba(255,255,255,0.95);">
          <div class="card-body">
            <h1 class="display-4 fw-bold text-primary mb-3">
              <ruby>é“<rt>ã¿ã¡</rt></ruby>ã‚’<ruby>åˆ‡<rt>ã</rt></ruby>ã‚Š<ruby>æ‹“<rt>ã²ã‚‰</rt></ruby>ã‘ï¼
            </h1>
            <p class="lead text-muted mb-4">
              <ruby>ç›¸æ‰‹<rt>ã‚ã„ã¦</rt></ruby>ã®ã‚´ãƒ¼ãƒ«ã‚’<ruby>ç›®æŒ‡<rt>ã‚ã–</rt></ruby>ã™<ruby>å¯¾æˆ¦<rt>ãŸã„ã›ã‚“</rt></ruby>ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ 
            </p>
            
            <div class="mb-4 text-start bg-light p-3 rounded-3">
              <label for="select-board-size" class="form-label fw-bold">
                ãƒœãƒ¼ãƒ‰ã®<ruby>å¤§<rt>ãŠãŠ</rt></ruby>ãã•
              </label>
              <select id="select-board-size" class="form-select form-select-lg border-2">
                <option value="7">7x7 (ãµã¤ã†)</option>
                <option value="9" selected>9x9 (ã‚€ãšã‹ã—ã„)</option>
                <option value="5">5x5 (ã‹ã‚“ãŸã‚“)</option>
              </select>
            </div>

            <button id="btn-start" class="btn btn-primary-pop btn-lg w-100 py-3 fs-3 shadow">
              ã‚²ãƒ¼ãƒ <ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby>ï¼
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==========================
         2. ã‚²ãƒ¼ãƒ ç”»é¢
         ========================== -->
    <div id="game-screen" class="d-none">
      
      <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
      <div class="text-center mb-3">
        <h2 id="game-message" class="fw-bold bg-white d-inline-block px-4 py-2 rounded-pill shadow-sm border">
          <ruby>æº–å‚™<rt>ã˜ã‚…ã‚“ã³</rt></ruby><ruby>ä¸­<rt>ã¡ã‚…ã†</rt></ruby>...
        </h2>
      </div>

      <div class="row g-2 justify-content-center">
        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1 (é’) æƒ…å ± -->
        <div class="col-6 col-md-3 order-2 order-md-1">
          <div id="p1-panel" class="card p-2 text-center shadow-sm h-100 justify-content-center">
            <div class="fw-bold text-primary fs-5"><ruby>é’<rt>ã‚ãŠ</rt></ruby>ãƒãƒ¼ãƒ </div>
            <div class="d-flex align-items-center justify-content-center my-1">
              <span class="fs-2 me-2">ğŸ”µ</span>
              <div class="text-start lh-1">
                <div style="font-size:0.8em; color:#666;">ã®ã“ã‚Šã‚«ãƒ™</div>
                <div><span id="p1-walls" class="display-4 fw-bold wall-count-display">10</span><span class="small"> <ruby>æš<rt>ã¾ã„</rt></ruby></span></div>
              </div>
            </div>
            <div class="badge bg-primary mt-1 py-2" style="white-space: normal; line-height: 1.5;">
              <ruby>å³<rt>ã¿ã</rt></ruby>ã¸<ruby>é€²<rt>ã™ã™</rt></ruby>ã‚ï¼ ğŸ‘‰
            </div>
          </div>
        </div>

        <!-- ç›¤é¢ã‚¨ãƒªã‚¢ -->
        <div class="col-12 col-md-6 order-1 order-md-2 d-flex justify-content-center mb-2">
          <div class="game-card">
            <div id="game-area">
              <div id="board">
                <!-- JSã§ãƒã‚¹ç›®ã‚’ç”Ÿæˆ -->
              </div>
            </div>
          </div>
        </div>

        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2 (èµ¤) æƒ…å ± -->
        <div class="col-6 col-md-3 order-3 order-md-3">
          <div id="p2-panel" class="card p-2 text-center shadow-sm h-100 justify-content-center">
            <div class="fw-bold text-danger fs-5"><ruby>èµ¤<rt>ã‚ã‹</rt></ruby>ãƒãƒ¼ãƒ </div>
            <div class="d-flex align-items-center justify-content-center my-1">
              <span class="fs-2 me-2">ğŸ”´</span>
              <div class="text-start lh-1">
                <div style="font-size:0.8em; color:#666;">ã®ã“ã‚Šã‚«ãƒ™</div>
                <div><span id="p2-walls" class="display-4 fw-bold wall-count-display">10</span><span class="small"> <ruby>æš<rt>ã¾ã„</rt></ruby></span></div>
              </div>
            </div>
            <div class="badge bg-danger mt-1 py-2" style="white-space: normal; line-height: 1.5;">
              ğŸ‘ˆ <ruby>å·¦<rt>ã²ã ã‚Š</rt></ruby>ã¸<ruby>é€²<rt>ã™ã™</rt></ruby>ã‚ï¼
            </div>
          </div>
        </div>
      </div>

      <!-- æ“ä½œãƒ‘ãƒãƒ« (ä¸‹éƒ¨å›ºå®š) -->
      <div class="fixed-bottom bg-white border-top py-2 px-3 shadow-lg" style="z-index: 1000;">
        <div class="container-fluid mw-800 mx-auto">
          <div class="row g-2 align-items-center">
            
            <div class="col-4">
              <button id="btn-mode-move" class="btn btn-primary-pop w-100 py-3 h-100 d-flex flex-column align-items-center justify-content-center">
                <span class="fs-3">ğŸƒ</span>
                <span class="small fw-bold"><ruby>æ­©<rt>ã‚ã‚‹</rt></ruby>ã</span>
              </button>
            </div>
            
            <div class="col-4">
              <button id="btn-mode-wall" class="btn btn-light btn-pop w-100 py-3 h-100 d-flex flex-column align-items-center justify-content-center border">
                <span class="fs-3">ğŸš§</span>
                <span class="small fw-bold">ã‚«ãƒ™</span>
              </button>
            </div>

            <div class="col-4">
              <!-- ã‚«ãƒ™æ“ä½œç”¨ã®ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
              <div id="wall-controls" class="d-none h-100">
                <button id="btn-rotate-wall" class="btn btn-warning w-100 py-2 h-100 fw-bold border-2 border-dark rounded-3 shadow-sm text-dark">
                  ä»Šã¯ <b>ã‚¿ãƒ†</b><br>
                  <small class="fs-6"><ruby>æŠ¼<rt>ãŠ</rt></ruby>ã™ã¨ãƒ¨ã‚³</small>
                </button>
              </div>
              <!-- ç§»å‹•ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º -->
              <div id="move-hint" class="text-center text-muted small d-flex align-items-center justify-content-center h-100">
                <span class="d-none d-md-inline fw-bold"><ruby>å…‰<rt>ã²ã‹</rt></ruby>ã‚‹ãƒã‚¹ã‚’<br>ã‚¿ãƒƒãƒ—ï¼</span>
              </div>
            </div>

          </div>
        </div>
      </div>
      <!-- æ“ä½œãƒ‘ãƒãƒ«ã®è£ã«ä½™ç™½ã‚’ä½œã‚‹ï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒéš ã‚Œãªã„ã‚ˆã†ã«ï¼‰ -->
      <div style="height: 110px;"></div>

    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer class="text-center text-muted py-3 mt-auto border-top bg-white">
    <small>Â© 2026 ã‚«ãƒ™<ruby>åˆæˆ¦<rt>ãŒã£ã›ã‚“</rt></ruby>ï¼ <a href="https://note.com/cute_borage86" target="_blank" class="text-decoration-none text-muted">GIGAå±±</a></small>
  </footer>

  <!-- SweetAlert2 (ã‚¢ãƒ©ãƒ¼ãƒˆç”¨) -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ -->
  <script>
    // =================================================================
    //  GIGA Game Architect - Game Engine (Standalone Version)
    //  ã‚¢ãƒ—ãƒªå: ã‚«ãƒ™åˆæˆ¦ï¼
    // =================================================================

    // --- 1. ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç† (State Management) ---
    const GAME_CONFIG = {
      p1Color: 'é’',
      p2Color: 'èµ¤',
      p1Class: 'p1',
      p2Class: 'p2'
    };

    let gameState = {
      boardSize: 9,      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯9x9
      players: {},       // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®æƒ…å ±
      walls: [],         // è¨­ç½®ã•ã‚ŒãŸã‚«ãƒ™ {row, col, orientation}
      turn: 1,           // 1: é’ãƒãƒ¼ãƒ , 2: èµ¤ãƒãƒ¼ãƒ 
      wallsLeft: { 1: 10, 2: 10 },
      winner: null,
      mode: 'move',      // 'move' (ç§»å‹•) or 'wall' (ã‚«ãƒ™)
      wallOrientation: 'v' // 'v' (ã‚¿ãƒ†) or 'h' (ãƒ¨ã‚³)
    };

    // --- 2. åˆæœŸåŒ–ã¨DOMã‚¤ãƒ™ãƒ³ãƒˆ (Initialization) ---
    document.addEventListener('DOMContentLoaded', () => {
      // åˆæœŸè¨­å®šç”»é¢ã®è¡¨ç¤º
      setupGameDOM();
      
      // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
      document.getElementById('btn-start').addEventListener('click', () => {
        const size = parseInt(document.getElementById('select-board-size').value);
        initGame(size);
      });

      // æ“ä½œãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
      document.getElementById('btn-mode-move').addEventListener('click', () => setMode('move'));
      document.getElementById('btn-mode-wall').addEventListener('click', () => setMode('wall'));
      document.getElementById('btn-rotate-wall').addEventListener('click', toggleWallOrientation);
      
      // ãƒ«ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
      document.getElementById('btn-rule').addEventListener('click', showRules);
    });

    // UIã®åˆæœŸçŠ¶æ…‹ã‚’ã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
    function setupGameDOM() {
      document.getElementById('setup-screen').classList.remove('d-none');
      document.getElementById('game-screen').classList.add('d-none');
      document.getElementById('game-message').textContent = 'æº–å‚™ä¸­...';
    }

    function initGame(size) {
      // çŠ¶æ…‹ã®åˆæœŸåŒ–
      gameState.boardSize = size;
      gameState.walls = [];
      gameState.turn = 1;
      gameState.winner = null;
      gameState.mode = 'move';
      
      // ã‚«ãƒ™ã®æšæ•°è¨ˆç®— (å…¬å¼ãƒ«ãƒ¼ãƒ«ã«è¿‘ã„æ¯”ç‡)
      const initialWalls = size === 9 ? 10 : Math.floor((size * size) / 8);
      gameState.wallsLeft = { 1: initialWalls, 2: initialWalls };

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸä½ç½® (å·¦ vs å³)
      // é’(1): å·¦ç«¯ã®ä¸­å¤® -> å³ç«¯ã‚’ç›®æŒ‡ã™
      // èµ¤(2): å³ç«¯ã®ä¸­å¤® -> å·¦ç«¯ã‚’ç›®æŒ‡ã™
      const center = Math.floor(size / 2);
      gameState.players = {
        1: { row: center, col: 0, goalCol: size - 1 },
        2: { row: center, col: size - 1, goalCol: 0 }
      };

      // UIåˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('setup-screen').classList.add('d-none');
      document.getElementById('game-screen').classList.remove('d-none');
      
      renderBoard();
      updateStatusUI();
      updateTurnIndicator();
    }

    // --- 3. æç”»ãƒ­ã‚¸ãƒƒã‚¯ (Rendering) ---

    function renderBoard() {
      const board = document.getElementById('board');
      const size = gameState.boardSize;
      
      // ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å‹•çš„ç”Ÿæˆ
      board.innerHTML = '';
      board.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
      board.style.gridTemplateRows = `repeat(${size}, 1fr)`;
      
      // ã‚¹ãƒãƒ›ã§ã‚‚è¦‹ã‚„ã™ã„ã‚µã‚¤ã‚ºè¨ˆç®—
      const boardWidth = Math.min(window.innerWidth - 40, 600); // æœ€å¤§600px
      // é«˜ã•ã‚‚å¹…ã¨åŒã˜ã«ã—ã¦æ­£æ–¹å½¢ã«
      board.style.width = `${boardWidth}px`;
      board.style.height = `${boardWidth}px`;

      // ãƒã‚¹ç›®ã®ç”Ÿæˆ
      for (let r = 0; r < size; r++) {
        for (let c = 0; c < size; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = r;
          cell.dataset.col = c;
          
          // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
          cell.onclick = () => handleCellClick(r, c);
          
          // ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå£ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
          cell.onmouseenter = () => showWallPreview(r, c);
          cell.onmouseleave = () => clearWallPreview();
          
          board.appendChild(cell);
        }
      }

      // ç›¤é¢ã‹ã‚‰å‡ºãŸã¨ãã‚‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¶ˆã™
      board.onmouseleave = () => clearWallPreview();

      drawPawns();
      drawWalls(boardWidth, size);
      highlightValidMoves();
    }

    function drawPawns() {
      // æ—¢å­˜ã®ã‚³ãƒã‚’å‰Šé™¤
      document.querySelectorAll('.pawn').forEach(el => el.remove());
      
      Object.keys(gameState.players).forEach(pid => {
        const p = gameState.players[pid];
        const cell = document.querySelector(`.cell[data-row='${p.row}'][data-col='${p.col}']`);
        if (cell) {
          const pawn = document.createElement('div');
          pawn.className = `pawn p${pid}`;
          pawn.innerHTML = pid === '1' ? 'ğŸ”µ' : 'ğŸ”´'; // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ã‚¤ã‚³ãƒ³
          pawn.style.display = 'flex';
          pawn.style.justifyContent = 'center';
          pawn.style.alignItems = 'center';
          pawn.style.fontSize = '1.2em';
          cell.appendChild(pawn);
        }
      });
    }

    function drawWalls(boardWidth, size) {
      // æ—¢å­˜ã®ã‚«ãƒ™ã‚’å‰Šé™¤
      document.querySelectorAll('.wall').forEach(el => el.remove());
      
      const board = document.getElementById('board');
      // ã‚»ãƒ«ã®å®Ÿã‚µã‚¤ã‚ºã‚’å–å¾—ï¼ˆæ­£ç¢ºãªé…ç½®ã®ãŸã‚ï¼‰
      const cells = document.querySelectorAll('.cell');
      if (cells.length === 0) return;
      
      const cellRect = cells[0].getBoundingClientRect();
      const gap = 4; // CSSã®gap
      
      gameState.walls.forEach(w => {
        createWallElement(board, cellRect, gap, w.row, w.col, w.orientation, false);
      });
    }

    // ã‚«ãƒ™è¦ç´ ã‚’ä½œæˆã™ã‚‹å…±é€šé–¢æ•° (æç”»ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å…±æœ‰)
    function createWallElement(container, cellRect, gap, r, c, orientation, isPreview) {
      const wall = document.createElement('div');
      wall.className = isPreview ? 'wall-preview' : 'wall';
      
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«
      if (isPreview) {
        wall.style.position = 'absolute';
        wall.style.borderRadius = '4px';
        wall.style.zIndex = '100'; // æœ€å‰é¢
        wall.style.pointerEvents = 'none'; // ã‚¯ãƒªãƒƒã‚¯ã‚’é‚ªé­”ã—ãªã„
        wall.style.opacity = '0.6';
      }

      // ã‚«ãƒ™ã®æç”»ä½ç½®è¨ˆç®—
      if (orientation === 'h') {
        // æ¨ªå‘ã: ä¸‹ã®å¢ƒç•Œç·š
        const cellTarget = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
        if(cellTarget) {
          wall.style.height = `${gap * 2}px`; // å°‘ã—å¤ªã‚ã«
          wall.style.width = `${(cellRect.width * 2) + gap}px`;
          wall.style.top = `${cellTarget.offsetTop + cellRect.height - (gap/2)}px`;
          wall.style.left = `${cellTarget.offsetLeft}px`;
        }
      } else {
        // ç¸¦å‘ã: å³ã®å¢ƒç•Œç·š
        const cellTarget = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
        if(cellTarget) {
          wall.style.width = `${gap * 2}px`;
          wall.style.height = `${(cellRect.height * 2) + gap}px`;
          wall.style.top = `${cellTarget.offsetTop}px`;
          wall.style.left = `${cellTarget.offsetLeft + cellRect.width - (gap/2)}px`;
        }
      }
      container.appendChild(wall);
      return wall;
    }

    // ã‚«ãƒ™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function showWallPreview(r, c) {
      if (gameState.mode !== 'wall' || gameState.winner) return;

      clearWallPreview();
      
      const board = document.getElementById('board');
      const cells = document.querySelectorAll('.cell');
      if (cells.length === 0) return;
      const cellRect = cells[0].getBoundingClientRect();
      const gap = 4;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦è‰²ã‚’æ±ºã‚ã‚‹
      let isValid = true;
      
      // ç¯„å›²å¤–ãƒã‚§ãƒƒã‚¯
      if (gameState.wallOrientation === 'v' && r >= gameState.boardSize - 1) isValid = false; // ä¸‹ã«ã¯ã¿å‡ºã‚‹
      if (gameState.wallOrientation === 'v' && c >= gameState.boardSize - 1) isValid = false; // å³ã«ã¯ã¿å‡ºã‚‹
      if (gameState.wallOrientation === 'h' && c >= gameState.boardSize - 1) isValid = false; // å³ã«ã¯ã¿å‡ºã‚‹
      if (gameState.wallOrientation === 'h' && r >= gameState.boardSize - 1) isValid = false; // ä¸‹ã«ã¯ã¿å‡ºã‚‹

      // ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
      if (isValid) {
        const error = validateWall(r, c, gameState.wallOrientation);
        if (error) isValid = false;
      }

      const wall = createWallElement(board, cellRect, gap, r, c, gameState.wallOrientation, true);
      
      // è‰²ã®é©ç”¨
      if (isValid) {
        wall.style.backgroundColor = '#ffca28'; // æœ‰åŠ¹ãªã‚‰é»„è‰²ï¼ˆã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ï¼‰
        wall.style.border = '2px dashed #3e2723';
      } else {
        wall.style.backgroundColor = '#ff5252'; // ç„¡åŠ¹ãªã‚‰èµ¤
        wall.style.border = '2px dashed white';
      }
    }

    // ã‚«ãƒ™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¶ˆå»
    function clearWallPreview() {
      document.querySelectorAll('.wall-preview').forEach(el => el.remove());
    }


    // --- 4. æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ (Interaction) ---

    // ãƒã‚¹ç›®ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãï¼ˆç§»å‹• or ã‚«ãƒ™è¨­ç½®ã®èµ·ç‚¹ï¼‰
    function handleCellClick(r, c) {
      if (gameState.winner) return;

      if (gameState.mode === 'move') {
        // ç§»å‹•å‡¦ç†
        tryMove(r, c);
      } else {
        // ã‚«ãƒ™è¨­ç½®å‡¦ç†
        // ç«¯ã£ã“ï¼ˆå³ç«¯ã€ä¸‹ç«¯ï¼‰ã‚’é¸æŠã—ãŸå ´åˆã®ã‚¬ãƒ¼ãƒ‰
        if (r >= gameState.boardSize - 1 && gameState.wallOrientation === 'v') {
             Swal.fire({
               icon: 'info',
               title: getRubyText('ç½®(ãŠ)ã‘ã¾ã›ã‚“'),
               text: 'ä¸‹(ã—ãŸ)ã«ã¯ã¿å‡º(ã )ã—ã¦ã—ã¾ã„ã¾ã™ã€‚',
               timer: 1500,
               showConfirmButton: false
             });
             return;
        }
        // ãã®ä»–ã®ç¯„å›²å¤–ã‚¬ãƒ¼ãƒ‰
        if (c >= gameState.boardSize - 1 && gameState.wallOrientation === 'h') {
             Swal.fire({ icon: 'info', title: getRubyText('ç½®(ãŠ)ã‘ã¾ã›ã‚“'), text: 'å³(ã¿ã)ã«ã¯ã¿å‡º(ã )ã—ã¦ã—ã¾ã„ã¾ã™ã€‚', timer: 1500, showConfirmButton: false });
             return;
        }
        if (gameState.wallOrientation === 'h' && r >= gameState.boardSize - 1) {
             Swal.fire({ icon: 'info', title: getRubyText('ç½®(ãŠ)ã‘ã¾ã›ã‚“'), text: 'å¤–æ (ãã¨ã‚ã)ã«ã¯ç½®(ãŠ)ã‘ã¾ã›ã‚“', timer: 1000, showConfirmButton: false });
             return;
        }
        if (gameState.wallOrientation === 'v' && c >= gameState.boardSize - 1) {
             Swal.fire({ icon: 'info', title: getRubyText('ç½®(ãŠ)ã‘ã¾ã›ã‚“'), text: 'å¤–æ (ãã¨ã‚ã)ã«ã¯ç½®(ãŠ)ã‘ã¾ã›ã‚“', timer: 1000, showConfirmButton: false });
             return;
        }

        tryPlaceWall(r, c, gameState.wallOrientation);
      }
    }

    function tryMove(r, c) {
      const pid = gameState.turn;
      const player = gameState.players[pid];
      
      // æœ‰åŠ¹ãªç§»å‹•ã‹ãƒã‚§ãƒƒã‚¯
      if (isValidMove(player, r, c)) {
        // ç§»å‹•å®Ÿè¡Œ
        player.row = r;
        player.col = c;
        
        // å‹åˆ©åˆ¤å®š
        if (player.col === player.goalCol) {
          handleWin(pid);
        } else {
          switchTurn();
        }
      }
    }

    function tryPlaceWall(r, c, orientation) {
      const pid = gameState.turn;
      
      // ã‚«ãƒ™ã®æ®‹ã‚Šæšæ•°ãƒã‚§ãƒƒã‚¯
      if (gameState.wallsLeft[pid] <= 0) {
        Swal.fire({
          icon: 'warning',
          title: getRubyText('ã‚«ãƒ™ãŒã‚ã‚Šã¾ã›ã‚“ï¼'),
          html: getRubyText('ã‚‚ã†ã‚«ãƒ™ã‚’<ruby>ä½¿<rt>ã¤ã‹</rt></ruby>ã„<ruby>åˆ‡<rt>ã</rt></ruby>ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚<br>ã‚³ãƒã‚’<ruby>å‹•<rt>ã†ã”</rt></ruby>ã‹ã—ã¦ãã ã•ã„ã€‚'),
          confirmButtonColor: '#ffca28'
        });
        return;
      }

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const errorMsg = validateWall(r, c, orientation);
      if (errorMsg) {
        Swal.fire({
          icon: 'error',
          title: getRubyText('ç½®(ãŠ)ã‘ã¾ã›ã‚“'),
          text: errorMsg,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 2000
        });
        return;
      }

      // è¨­ç½®å®Ÿè¡Œ
      gameState.walls.push({ row: r, col: c, orientation: orientation });
      gameState.wallsLeft[pid]--;
      
      switchTurn();
    }

    function switchTurn() {
      gameState.turn = gameState.turn === 1 ? 2 : 1;
      renderBoard(); // å†æç”»
      updateStatusUI();
      updateTurnIndicator();
    }

    function handleWin(pid) {
      gameState.winner = pid;
      renderBoard();
      
      const teamName = pid === 1 ? "é’(ã‚ãŠ)ãƒãƒ¼ãƒ " : "èµ¤(ã‚ã‹)ãƒãƒ¼ãƒ ";
      const color = pid === 1 ? "#2979ff" : "#ff1744";
      
      Swal.fire({
        title: getRubyText('å‹è² (ã—ã‚‡ã†ã¶)ã‚ã‚Šï¼'),
        html: `<h2 style="color:${color}; font-weight:bold;">ğŸ‰ ${getRubyText(pid === 1 ? 'é’(ã‚ãŠ)' : 'èµ¤(ã‚ã‹)')}ãƒãƒ¼ãƒ ã®<ruby>å‹<rt>ã‹</rt></ruby>ã¡ï¼ ğŸ‰</h2>`,
        icon: 'success',
        background: '#fff9c4',
        confirmButtonText: getRubyText('ã‚‚ã†ä¸€å›(ã„ã£ã‹ã„)éŠ(ã‚ã)ã¶'),
        confirmButtonColor: color,
        allowOutsideClick: false
      }).then((result) => {
        if (result.isConfirmed) {
          // ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã¸
          document.getElementById('setup-screen').classList.remove('d-none');
          document.getElementById('game-screen').classList.add('d-none');
        }
      });
    }

    // --- 5. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ & ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (Logic) ---

    // ç§»å‹•åˆ¤å®š
    function isValidMove(currentP, targetR, targetC) {
      // ç¾åœ¨åœ°ã¨ç›®çš„åœ°ãŒåŒã˜ãªã‚‰ç„¡åŠ¹
      if (currentP.row === targetR && currentP.col === targetC) return false;

      const opponentPid = gameState.turn === 1 ? 2 : 1;
      const opponent = gameState.players[opponentPid];
      
      // 1. éš£æ¥ç§»å‹•ãƒã‚§ãƒƒã‚¯
      const dist = Math.abs(currentP.row - targetR) + Math.abs(currentP.col - targetC);
      
      // é€šå¸¸ç§»å‹• (è·é›¢1)
      if (dist === 1) {
        // ç›¸æ‰‹ãŒã„ã‚‹å ´æ‰€ã«ã¯è¡Œã‘ãªã„
        if (targetR === opponent.row && targetC === opponent.col) return false;
        return !isWallBlocking(currentP.row, currentP.col, targetR, targetC);
      }
      
      // ã‚¸ãƒ£ãƒ³ãƒ—ç§»å‹• (è·é›¢2)
      if (dist === 2) {
        // ç›´ç·šã‚¸ãƒ£ãƒ³ãƒ—
        if ((currentP.row === targetR || currentP.col === targetC)) {
           // é–“ã«ç›¸æ‰‹ãŒã„ã‚‹ã‹ï¼Ÿ
           const midR = (currentP.row + targetR) / 2;
           const midC = (currentP.col + targetC) / 2;
           if (opponent.row === midR && opponent.col === midC) {
             // è‡ªåˆ†ã®ç›®ã®å‰ã«ã‚«ãƒ™ãŒãªãã€ç›¸æ‰‹ã®å¾Œã‚ã«ã‚‚ã‚«ãƒ™ãŒãªã„
             return !isWallBlocking(currentP.row, currentP.col, midR, midC) && 
                    !isWallBlocking(midR, midC, targetR, targetC);
           }
        }
      }
      return false;
    }

    // ã‚«ãƒ™åˆ¤å®š (ç§»å‹•ç”¨)
    function isWallBlocking(r1, c1, r2, c2) {
      for (const w of gameState.walls) {
        if (w.orientation === 'h') {
          // æ¨ªã‚«ãƒ™: w.row ã¨ w.row+1 ã®å¢ƒç•Œç·šä¸Š
          // ç§»å‹•ãŒç¸¦æ–¹å‘(rãŒå¤‰ã‚ã‚‹)ã§ã€ã‹ã¤ã‚«ãƒ™ã®è¡Œã‚’è·¨ãå ´åˆ
          // ã‚«ãƒ™ã¯ col ã‹ã‚‰ col+1 ã¾ã§å­˜åœ¨
          if (Math.abs(r1 - r2) === 1) {
            const borderRow = Math.min(r1, r2); // ã‚«ãƒ™ãŒã‚ã‚‹ã¹ãè¡Œ (rowã¨row+1ã®é–“ = row)
            if (w.row === borderRow) {
               // åˆ—ãŒã‚«ãƒ™ã®ç¯„å›²å†…ã‹ (c1ã¯ç§»å‹•å…ƒã€c2ã‚‚åŒã˜ã¯ãšã ãŒã€ã“ã“ã¯åˆ—ãŒå¤‰ã‚ã‚‰ãªã„å‰æ)
               // ç¸¦ç§»å‹•ãªã®ã§ c1 === c2
               if (c1 === w.col || c1 === w.col + 1) return true;
            }
          }
        } else {
          // ç¸¦ã‚«ãƒ™: w.col ã¨ w.col+1 ã®å¢ƒç•Œç·šä¸Š
          if (Math.abs(c1 - c2) === 1) {
            const borderCol = Math.min(c1, c2);
            if (w.col === borderCol) {
               if (r1 === w.row || r1 === w.row + 1) return true;
            }
          }
        }
      }
      return false;
    }

    // ã‚«ãƒ™è¨­ç½®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateWall(r, c, orientation) {
      // 1. é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
      for (const w of gameState.walls) {
        if (w.row === r && w.col === c && w.orientation === orientation) return "ãã“ã«ã‚«ãƒ™ã¯ã‚ã‚Šã¾ã™ã€‚";
        if (w.row === r && w.col === c) return "ã‚«ãƒ™ãŒã‚¯ãƒ­ã‚¹ã—ã¦ã—ã¾ã„ã¾ã™ã€‚"; // åå­—äº¤å·®ç¦æ­¢
        
        // ä¸€éƒ¨é‡ãªã‚Š (ç›´åˆ—é…ç½®ã§ã®è¢«ã‚Š)
        // æ¨ªã‚«ãƒ™åŒå£«: è¡ŒãŒåŒã˜ã§ã€åˆ—ãŒ1ã‚ºãƒ¬ã¦ã„ã‚‹ã¨é‡ãªã‚‹ (é•·ã•2ãªã®ã§)
        if (orientation === 'h' && w.orientation === 'h' && w.row === r && Math.abs(w.col - c) === 1) return "ã‚«ãƒ™ãŒé‡(ã‹ã•)ãªã‚Šã¾ã™ã€‚";
        // ç¸¦ã‚«ãƒ™åŒå£«: åˆ—ãŒåŒã˜ã§ã€è¡ŒãŒ1ã‚ºãƒ¬ã¦ã„ã‚‹ã¨é‡ãªã‚‹
        if (orientation === 'v' && w.orientation === 'v' && w.col === c && Math.abs(w.row - r) === 1) return "ã‚«ãƒ™ãŒé‡(ã‹ã•)ãªã‚Šã¾ã™ã€‚";
      }

      // 2. çµŒè·¯å°é–ãƒã‚§ãƒƒã‚¯ (BFS)
      gameState.walls.push({ row: r, col: c, orientation: orientation }); // ä»®ç½®ã
      
      const p1CanReach = pathExists(1);
      const p2CanReach = pathExists(2);
      
      gameState.walls.pop(); // å…ƒã«æˆ»ã™
      
      if (!p1CanReach || !p2CanReach) {
        return "ã‚´ãƒ¼ãƒ«ã¸ã®é“(ã¿ã¡)ãŒãªããªã£ã¦ã—ã¾ã„ã¾ã™ï¼";
      }
      
      return null; // OK
    }

    // BFSã«ã‚ˆã‚‹çµŒè·¯æ¢ç´¢
    function pathExists(pid) {
      const p = gameState.players[pid];
      const goalCol = p.goalCol;
      const size = gameState.boardSize;
      
      let queue = [{ r: p.row, c: p.col }];
      let visited = new Set();
      visited.add(`${p.row},${p.col}`);
      
      const directions = [
        {dr: -1, dc: 0}, {dr: 1, dc: 0}, {dr: 0, dc: -1}, {dr: 0, dc: 1}
      ];
      
      while (queue.length > 0) {
        const {r, c} = queue.shift();
        
        if (c === goalCol) return true; // åˆ°é”ï¼
        
        for (const d of directions) {
          const nr = r + d.dr;
          const nc = c + d.dc;
          
          if (nr >= 0 && nr < size && nc >= 0 && nc < size) {
            if (!visited.has(`${nr},${nc}`)) {
              // ç§»å‹•å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚«ãƒ™ãŒãªã„ã‹ï¼‰
              if (!isWallBlocking(r, c, nr, nc)) {
                visited.add(`${nr},${nc}`);
                queue.push({ r: nr, c: nc });
              }
            }
          }
        }
      }
      return false;
    }

    // --- 6. UI ãƒ˜ãƒ«ãƒ‘ãƒ¼ (UI Helpers) ---

    function updateStatusUI() {
      const t = gameState.turn;
      
      // ã‚«ãƒ™æ®‹æ•°è¡¨ç¤º
      document.getElementById('p1-walls').textContent = gameState.wallsLeft[1];
      document.getElementById('p2-walls').textContent = gameState.wallsLeft[2];
      
      // ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      document.getElementById('p1-panel').className = `card p-2 text-center shadow-sm h-100 justify-content-center ${t === 1 ? 'border-primary bg-light' : ''}`;
      document.getElementById('p2-panel').className = `card p-2 text-center shadow-sm h-100 justify-content-center ${t === 2 ? 'border-danger bg-light' : ''}`;
      
      // ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹
      const isMove = gameState.mode === 'move';
      const btnMove = document.getElementById('btn-mode-move');
      const btnWall = document.getElementById('btn-mode-wall');
      
      if (isMove) {
        btnMove.classList.add('btn-primary-pop');
        btnMove.classList.remove('btn-light');
        btnWall.classList.add('btn-light');
        btnWall.classList.remove('btn-pop'); // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã¯è‰²ä»˜ããªã®ã§popã‚¯ãƒ©ã‚¹ä»˜ã‘æ›¿ãˆ
        btnWall.style.backgroundColor = '#f8f9fa';
        btnWall.style.color = '#000';
        
        document.getElementById('wall-controls').classList.add('d-none');
        document.getElementById('move-hint').classList.remove('d-none');
        clearWallPreview(); // ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¶ˆã™
      } else {
        btnMove.classList.add('btn-light');
        btnMove.classList.remove('btn-primary-pop');
        
        btnWall.classList.remove('btn-light');
        // ã‚«ãƒ™ãƒ¢ãƒ¼ãƒ‰ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è‰²ï¼ˆé»„è‰²ï¼‰
        btnWall.style.backgroundColor = '#ffca28';
        btnWall.style.color = '#3e2723';
        
        document.getElementById('wall-controls').classList.remove('d-none');
        document.getElementById('move-hint').classList.add('d-none');
        
        // å£å‘ããƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
        const oriBtn = document.getElementById('btn-rotate-wall');
        oriBtn.innerHTML = gameState.wallOrientation === 'v' 
          ? 'ä»Šã¯ <b>ã‚¿ãƒ†</b><br><small class="fs-6"><ruby>æŠ¼<rt>ãŠ</rt></ruby>ã™ã¨ãƒ¨ã‚³</small>' 
          : 'ä»Šã¯ <b>ãƒ¨ã‚³</b><br><small class="fs-6"><ruby>æŠ¼<rt>ãŠ</rt></ruby>ã™ã¨ã‚¿ãƒ†</small>';
      }
    }

    function updateTurnIndicator() {
      const msgEl = document.getElementById('game-message');
      if (gameState.turn === 1) {
        msgEl.innerHTML = getRubyText('é’(ã‚ãŠ)ãƒãƒ¼ãƒ ã®ç•ª(ã°ã‚“)ã§ã™');
        msgEl.style.color = 'var(--p1-color)';
        msgEl.style.borderColor = 'var(--p1-color)';
      } else {
        msgEl.innerHTML = getRubyText('èµ¤(ã‚ã‹)ãƒãƒ¼ãƒ ã®ç•ª(ã°ã‚“)ã§ã™');
        msgEl.style.color = 'var(--p2-color)';
        msgEl.style.borderColor = 'var(--p2-color)';
      }
    }

    function toggleWallOrientation() {
      gameState.wallOrientation = gameState.wallOrientation === 'v' ? 'h' : 'v';
      updateStatusUI();
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å‘ãã‚‚æ›´æ–°ã—ãŸã„ã®ã§ã€ä¸€åº¦æ¶ˆã™ï¼ˆãƒã‚¦ã‚¹å‹•ãã¨å†æç”»ã•ã‚Œã‚‹ï¼‰
      clearWallPreview();
    }

    function setMode(m) {
      gameState.mode = m;
      updateStatusUI();
      renderBoard(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°ã®ãŸã‚
    }

    function highlightValidMoves() {
      // ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ã‹ã¤å‹è² ãŒã¤ã„ã¦ã„ãªã„æ™‚ã ã‘
      if (gameState.mode !== 'move' || gameState.winner) return;

      const pid = gameState.turn;
      const p = gameState.players[pid];
      const size = gameState.boardSize;
      
      // å…¨ã‚»ãƒ«èµ°æŸ»ã—ã¦ã€ç§»å‹•å¯èƒ½ãªã‚‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¿½åŠ 
      for (let r = 0; r < size; r++) {
        for (let c = 0; c < size; c++) {
          if (isValidMove(p, r, c)) {
            const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
            if (cell) {
              const mark = document.createElement('div');
              mark.className = 'valid-move';
              cell.appendChild(mark);
            }
          }
        }
      }
    }

    // ãƒ«ãƒ“å¤‰æ›ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function getRubyText(text) {
      return text.replace(/([ä¸€-é¾ ]+)\(([ã-ã‚“ã‚¡-ãƒ³]+)\)/g, '<ruby>$1<rt>$2</rt></ruby>');
    }

    function showRules() {
      Swal.fire({
        title: getRubyText('ã‚ãã³ã‹ãŸ'),
        width: '600px',
        html: `
          <div style="font-family: 'Zen Maru Gothic', sans-serif;">
            <!-- Rule 1 -->
            <div class="rule-step">
              <div class="rule-title"><span class="rule-icon">1</span> ã‚´ãƒ¼ãƒ«ã‚’<ruby>ç›®æŒ‡<rt>ã‚ã–</rt></ruby>ã›ï¼</div>
              <div class="rule-visual">ğŸ”µ â¡ ğŸ &nbsp;&nbsp;&nbsp; ğŸ â¬… ğŸ”´</div>
              <div class="rule-desc"><ruby>é’<rt>ã‚ãŠ</rt></ruby>ã¯<ruby>å³<rt>ã¿ã</rt></ruby>ã¸ã€<ruby>èµ¤<rt>ã‚ã‹</rt></ruby>ã¯<ruby>å·¦<rt>ã²ã ã‚Š</rt></ruby>ã®ç«¯(ã¯ã—)ã¾ã§<ruby>é€²<rt>ã™ã™</rt></ruby>ã‚ã°<ruby>å‹<rt>ã‹</rt></ruby>ã¡ï¼</div>
            </div>
            <!-- Rule 2 -->
            <div class="rule-step">
              <div class="rule-title"><span class="rule-icon">2</span> ã©ã£ã¡ã‹1ã¤</div>
              <div class="rule-visual">ğŸƒ <ruby>æ­©<rt>ã‚ã‚‹</rt></ruby>ã <span style="font-size:0.7em; color:#999;">ã¾ãŸã¯</span> ğŸš§ ã‚«ãƒ™</div>
              <div class="rule-desc"><ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ã®<ruby>ç•ª<rt>ã°ã‚“</rt></ruby>ã«ã€Œã‚³ãƒã‚’1ãƒã‚¹<ruby>å‹•<rt>ã†ã”</rt></ruby>ã‹ã™ã€ã‹ã€Œã‚«ãƒ™ã‚’<ruby>ç½®<rt>ãŠ</rt></ruby>ãã€ã‹é¸(ãˆã‚‰)ã¼ã†ã€‚</div>
            </div>
            <!-- Rule 3 -->
            <div class="rule-step">
              <div class="rule-title"><span class="rule-icon">3</span> <ruby>é‚ªé­”<rt>ã˜ã‚ƒã¾</rt></ruby>ã—ã‚ˆã†</div>
              <div class="rule-visual">ğŸš§ğŸƒğŸš§ &nbsp; ğŸ†—<br><span style="font-size:0.5em; color:red;">âŒ <ruby>é–‰<rt>ã¨</rt></ruby>ã˜<ruby>è¾¼<rt>ã“</rt></ruby>ã‚ã¯ãƒ€ãƒ¡ï¼</span></div>
              <div class="rule-desc"><ruby>ç›¸æ‰‹<rt>ã‚ã„ã¦</rt></ruby>ã®<ruby>é“<rt>ã¿ã¡</rt></ruby>ã‚’ãµã•ã”ã†ï¼ã§ã‚‚ã€ã‚´ãƒ¼ãƒ«ã¸ã®<ruby>é“<rt>ã¿ã¡</rt></ruby>ã‚’<ruby>å®Œå…¨<rt>ã‹ã‚“ãœã‚“</rt></ruby>ã«ãªãã™ã®ã¯åå‰‡(ã¯ã‚“ãã)ã ã‚ˆã€‚</div>
            </div>
          </div>
        `,
        confirmButtonText: getRubyText('ã‚ã‹ã£ãŸï¼')
      });
    }
  </script>
</body>
</html>
